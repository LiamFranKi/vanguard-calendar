# üì± **PWA & PUSH NOTIFICATIONS - GU√çA COMPLETA**

Sistema completo de Progressive Web App (PWA) con notificaciones push para **Vanguard Calendar**.

---

## üéØ **RESUMEN**

Vanguard Calendar ahora es una **Progressive Web App (PWA)** completamente funcional con soporte para:

- ‚úÖ **Instalaci√≥n** en dispositivos m√≥viles y escritorio
- ‚úÖ **Funcionamiento offline** con cach√© inteligente
- ‚úÖ **Push Notifications** en tiempo real
- ‚úÖ **Iconos optimizados** para todas las plataformas
- ‚úÖ **Service Worker** para actualizaciones autom√°ticas
- ‚úÖ **Shortcuts** de aplicaci√≥n personalizados

---

## üöÄ **CARACTER√çSTICAS IMPLEMENTADAS**

### **1. PWA B√°sico**

#### **Manifest.json**
- **Nombre**: Vanguard Calendar
- **Nombre corto**: VCalendar
- **Tema**: Azul (#3b82f6) y Morado (#764ba2)
- **Display**: Standalone (sin barra de navegador)
- **Iconos**: 8 tama√±os (72x72 a 512x512)
- **Shortcuts**: Nueva Tarea, Nuevo Evento, Dashboard

#### **Service Worker**
- **Cach√©**: Network First con fallback a cach√©
- **Estrategia**: Peticiones API siempre por red, archivos est√°ticos en cach√©
- **Actualizaci√≥n autom√°tica**: Verifica cada minuto
- **Limpieza**: Elimina cach√©s antiguas autom√°ticamente

---

### **2. Push Notifications**

#### **Backend (Web-Push)**
- **VAPID Keys**: Generadas y configuradas
- **Tabla BD**: `push_subscriptions` con √≠ndices optimizados
- **API Endpoints**:
  - `GET /api/push/vapid-public-key` - Obtener clave p√∫blica
  - `POST /api/push/subscribe` - Suscribirse
  - `POST /api/push/unsubscribe` - Desuscribirse
  - `GET /api/push/subscriptions` - Listar suscripciones
  - `POST /api/push/test` - Enviar notificaci√≥n de prueba

#### **Frontend (React)**
- **Componente**: `PushNotificationManager`
- **Ubicaci√≥n**: P√°gina de Configuraci√≥n
- **Funciones**:
  - Solicitar permisos de notificaci√≥n
  - Suscribirse/desuscribirse de push
  - Enviar notificaci√≥n de prueba
  - Mostrar estado de suscripci√≥n

#### **Integraci√≥n Autom√°tica**
- **Tareas**: Notificaci√≥n al asignar, cambiar estado, comentar
- **Eventos**: Notificaci√≥n al crear, recordatorios 1 d√≠a antes y el d√≠a del evento
- **Sistema**: Integrado con `createNotification()` existente

---

## üîß **CONFIGURACI√ìN**

### **1. Agregar VAPID Keys al .env**

Abre el archivo `backend/.env` y agrega estas l√≠neas:

```env
# PWA - Push Notifications (VAPID Keys)
VAPID_PUBLIC_KEY=BPLdYypsRHQ4FNcldgRlXZRVui5ivS3Jjh1CaVzNpFerW3YZv2Lq1pmdSRVwYCnl6WaZQj6M_-Z0t8bjsAfI1yI
VAPID_PRIVATE_KEY=U8-7v2Dyskza0X_1CY7K-jWVibwHCCGtFFzqM1e1zbc
```

‚ö†Ô∏è **IMPORTANTE**: Estas claves son espec√≠ficas para este proyecto. No las compartas p√∫blicamente.

---

### **2. Ejecutar Migraci√≥n de Base de Datos**

Ejecuta el script SQL en pgAdmin:

```bash
migrations/014_CREATE_PUSH_SUBSCRIPTIONS.sql
```

Este script crea la tabla `push_subscriptions` con:
- Almacenamiento de endpoints de push
- Claves de encriptaci√≥n (p256dh, auth)
- √çndices para rendimiento
- Cascade delete al eliminar usuario

---

### **3. Generar Iconos PWA (Opcional)**

Los iconos temporales ya est√°n listos, pero para producci√≥n se recomienda:

**Opci√≥n 1: Usar herramienta online**
1. Ve a https://realfavicongenerator.net/
2. Sube tu logo (512x512 PNG)
3. Descarga el paquete completo
4. Reemplaza los archivos en `frontend/public/`

**Opci√≥n 2: Usar ImageMagick**
```bash
cd frontend/public
magick icon.svg -resize 72x72 icon-72x72.png
magick icon.svg -resize 96x96 icon-96x96.png
magick icon.svg -resize 128x128 icon-128x128.png
magick icon.svg -resize 144x144 icon-144x144.png
magick icon.svg -resize 152x152 icon-152x152.png
magick icon.svg -resize 192x192 icon-192x192.png
magick icon.svg -resize 384x384 icon-384x384.png
magick icon.svg -resize 512x512 icon-512x512.png
```

---

## üì± **C√ìMO USAR**

### **Para Usuarios**

#### **1. Instalar la PWA**

**En Android (Chrome):**
1. Abre el sitio web
2. Tap en el men√∫ (‚ãÆ)
3. Selecciona "Agregar a pantalla de inicio"
4. Confirma la instalaci√≥n

**En iOS (Safari):**
1. Abre el sitio web
2. Tap en el √≠cono de compartir (cuadro con flecha)
3. Selecciona "Agregar a inicio"
4. Confirma la instalaci√≥n

**En Escritorio (Chrome/Edge):**
1. Abre el sitio web
2. Busca el √≠cono de instalaci√≥n en la barra de direcciones
3. Click en "Instalar"
4. La app se abrir√° en una ventana independiente

---

#### **2. Activar Notificaciones Push**

1. Inicia sesi√≥n en Vanguard Calendar
2. Ve a **Configuraci√≥n** (‚öôÔ∏è)
3. Despl√°zate hasta la secci√≥n "üì± Notificaciones Push"
4. Click en **"üîî Activar Notificaciones"**
5. Acepta el permiso del navegador
6. ¬°Listo! Ahora recibir√°s notificaciones en tiempo real

**Probar las notificaciones:**
- Click en **"üß™ Probar"** para enviar una notificaci√≥n de prueba
- Si ves la notificaci√≥n, todo est√° funcionando correctamente

**Desactivar notificaciones:**
- Click en **"üîï Desactivar"** para cancelar la suscripci√≥n

---

### **Para Desarrolladores**

#### **1. Habilitar Service Worker en Desarrollo**

Por defecto, el Service Worker solo se registra en producci√≥n. Para habilitarlo en desarrollo:

Crea un archivo `.env` en `frontend/` con:
```env
VITE_ENABLE_SW=true
```

#### **2. Enviar Push Notifications Manualmente**

Usa la funci√≥n `sendPushToUser` desde cualquier controlador:

```javascript
import { sendPushToUser } from './push.controller.js';

// Enviar notificaci√≥n a un usuario espec√≠fico
await sendPushToUser(userId, {
  title: 'T√≠tulo de la notificaci√≥n',
  body: 'Mensaje de la notificaci√≥n',
  icon: '/icon-192x192.png',
  badge: '/icon-96x96.png',
  tag: 'unique-id',
  requireInteraction: false,
  data: {
    url: '/dashboard',
    custom_data: 'valor'
  }
});
```

#### **3. Enviar Push a M√∫ltiples Usuarios**

```javascript
import { sendPushToUsers } from './push.controller.js';

// Enviar notificaci√≥n a varios usuarios
await sendPushToUsers([userId1, userId2, userId3], {
  title: 'T√≠tulo',
  body: 'Mensaje',
  data: { url: '/tareas' }
});
```

#### **4. Integrar con createNotification**

El sistema ya est√° integrado. Para deshabilitar push en una notificaci√≥n espec√≠fica:

```javascript
await createNotification({
  usuario_id: userId,
  titulo: 'T√≠tulo',
  mensaje: 'Mensaje',
  tipo: 'info',
  relacionado_tipo: 'tarea',
  relacionado_id: tareaId,
  send_email: true,
  send_push: false  // ‚Üê Deshabilitar push
});
```

---

## üîê **SEGURIDAD Y PERMISOS**

### **Permisos de Navegador**

Las notificaciones push requieren permiso expl√≠cito del usuario. Estados posibles:

- **`default`**: A√∫n no se ha solicitado permiso
- **`granted`**: Usuario concedi√≥ permiso ‚úÖ
- **`denied`**: Usuario deneg√≥ permiso ‚ùå

### **Seguridad de Suscripciones**

- ‚úÖ Todas las suscripciones est√°n vinculadas a usuarios autenticados
- ‚úÖ Solo el usuario puede suscribirse/desuscribirse
- ‚úÖ Las claves VAPID son privadas y no se exponen al cliente
- ‚úÖ Comunicaci√≥n encriptada con HTTPS (requerido para push)

### **Limpieza Autom√°tica**

- üóëÔ∏è Suscripciones inv√°lidas se eliminan autom√°ticamente (410 Gone, 404)
- üóëÔ∏è Suscripciones se eliminan en cascade al eliminar usuario

---

## üåê **DEPLOYMENT A PRODUCCI√ìN**

### **1. Requisitos de HTTPS**

‚ö†Ô∏è **IMPORTANTE**: Las Push Notifications **SOLO funcionan con HTTPS**. 

En DigitalOcean:
1. Configura tu dominio (e.g., `calendar.vanguardschool.com`)
2. Instala SSL con Let's Encrypt (Certbot)
3. Configura Nginx para HTTPS

### **2. Variables de Entorno en Producci√≥n**

Aseg√∫rate de configurar en tu servidor:

```bash
VAPID_PUBLIC_KEY=BPLdYypsRHQ4FNcldgRlXZRVui5ivS3Jjh1CaVzNpFerW3YZv2Lq1pmdSRVwYCnl6WaZQj6M_-Z0t8bjsAfI1yI
VAPID_PRIVATE_KEY=U8-7v2Dyskza0X_1CY7K-jWVibwHCCGtFFzqM1e1zbc
NODE_ENV=production
FRONTEND_URL=https://calendar.vanguardschool.com
```

### **3. Build de Frontend**

El Service Worker se registrar√° autom√°ticamente en producci√≥n:

```bash
cd frontend
npm run build
```

### **4. Configurar Nginx**

Aseg√∫rate de servir correctamente el `manifest.json` y el `service-worker.js`:

```nginx
location /manifest.json {
    root /var/www/vanguard-calendar/frontend/build;
    add_header Cache-Control "public, max-age=3600";
}

location /service-worker.js {
    root /var/www/vanguard-calendar/frontend/build;
    add_header Cache-Control "no-cache";
}
```

---

## üß™ **TESTING**

### **1. Verificar Service Worker**

En Chrome DevTools:
1. Abre **Application** tab
2. Ve a **Service Workers**
3. Verifica que el SW est√© activo
4. Click en **Update** para forzar actualizaci√≥n

### **2. Probar Notificaciones**

1. Ve a Configuraci√≥n ‚Üí Notificaciones Push
2. Click en "Activar Notificaciones"
3. Acepta el permiso
4. Click en "üß™ Probar"
5. Deber√≠as recibir una notificaci√≥n inmediatamente

### **3. Simular Offline**

En Chrome DevTools:
1. Abre **Network** tab
2. Cambia "No throttling" a **"Offline"**
3. Recarga la p√°gina
4. La app deber√≠a funcionar con contenido en cach√©

---

## üêõ **TROUBLESHOOTING**

### **Problema: Service Worker no se registra**

**Soluci√≥n 1**: Verifica que est√©s en HTTPS o localhost
```javascript
// Service Workers requieren HTTPS (excepto localhost)
```

**Soluci√≥n 2**: Habilita en desarrollo
```env
# frontend/.env
VITE_ENABLE_SW=true
```

**Soluci√≥n 3**: Limpia la cach√© del navegador
```
Chrome DevTools ‚Üí Application ‚Üí Storage ‚Üí Clear site data
```

---

### **Problema: No recibo notificaciones push**

**Verificar claves VAPID**:
```bash
# Verifica que est√©n en backend/.env
echo $VAPID_PUBLIC_KEY
echo $VAPID_PRIVATE_KEY
```

**Verificar suscripci√≥n**:
```javascript
// En la consola del navegador
navigator.serviceWorker.ready.then(reg => 
  reg.pushManager.getSubscription().then(sub => console.log(sub))
);
```

**Verificar permisos**:
```javascript
console.log('Permiso:', Notification.permission);
// Debe ser "granted"
```

---

### **Problema: Notificaci√≥n no abre la p√°gina correcta**

El Service Worker maneja los clicks en notificaciones. Verifica:

```javascript
// En public/service-worker.js
self.addEventListener('notificationclick', (event) => {
  // Verifica que la URL sea correcta
  console.log('URL destino:', urlToOpen);
});
```

---

## üìä **ARQUITECTURA**

### **Flujo de Push Notifications**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   USUARIO    ‚îÇ
‚îÇ  (Frontend)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 1. Solicita suscripci√≥n
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    SERVICE   ‚îÇ
‚îÇ    WORKER    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 2. Crea suscripci√≥n push
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   BACKEND    ‚îÇ
‚îÇ  (Node.js)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 3. Almacena en BD
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  push_       ‚îÇ
‚îÇ  subscriptions‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 4. Evento (tarea, evento, etc.)
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND     ‚îÇ
‚îÇ sendPushToUser‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 5. Env√≠a push via web-push
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  GOOGLE FCM  ‚îÇ
‚îÇ  (o similar) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 6. Entrega al dispositivo
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SERVICE     ‚îÇ
‚îÇ  WORKER      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 7. Muestra notificaci√≥n
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  USUARIO ve  ‚îÇ
‚îÇ notificaci√≥n ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìö **RECURSOS ADICIONALES**

### **Documentaci√≥n Oficial**
- [Web Push Protocol](https://tools.ietf.org/html/rfc8030)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [Push API](https://developer.mozilla.org/en-US/docs/Web/API/Push_API)
- [Notifications API](https://developer.mozilla.org/en-US/docs/Web/API/Notifications_API)

### **Herramientas**
- [PWA Builder](https://www.pwabuilder.com/) - Validador de PWA
- [Lighthouse](https://developers.google.com/web/tools/lighthouse) - Auditor√≠a de PWA
- [Web Push Tester](https://web-push-codelab.glitch.me/) - Probar push notifications

---

## ‚úÖ **CHECKLIST DE IMPLEMENTACI√ìN**

- [x] Manifest.json configurado
- [x] Service Worker implementado
- [x] Estrategias de cach√© configuradas
- [x] Iconos PWA creados
- [x] VAPID keys generadas
- [x] Tabla push_subscriptions creada
- [x] Backend de push configurado
- [x] Frontend de suscripci√≥n implementado
- [x] Integraci√≥n con sistema de notificaciones
- [x] Componente PushNotificationManager
- [x] Testing de notificaciones
- [x] Documentaci√≥n completa

---

## üéâ **¬°TODO LISTO!**

Vanguard Calendar ahora es una **PWA completa** con notificaciones push en tiempo real. Los usuarios pueden:

1. ‚úÖ Instalar la app en cualquier dispositivo
2. ‚úÖ Usar la app offline
3. ‚úÖ Recibir notificaciones push instant√°neas
4. ‚úÖ Acceder r√°pidamente con shortcuts

**¬°Disfruta de tu aplicaci√≥n moderna y profesional!** üöÄüì±‚ú®

